import{U as d,t as i}from"./index-BKyi1mnf.js";import{a as u}from"./axios-Bo0ATomq.js";var A={VITE_URL:"https://vue3-course-api.hexschool.io/v2",VITE_API_PATH:"wuyi0020",VITE_ADMIN_USERNAME:"wuyi0020@gmail.com",VITE_ADMIN_PASSWORD:"wuyi0020",BASE_URL:"/pixelmissions/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const{VITE_URL:l,VITE_API_PATH:c,VITE_ADMIN_PASSWORD:m,VITE_ADMIN_USERNAME:g}=A,D=d("UserState",{state:()=>({userName:null,userEmail:null,userID:null,userHasLogIn:!1,AdminToken:null,Alldata:null,userData:null,lastGetAllDataTime:0}),getters:{getUserName(){return this.userName},getUserEmail(){return this.userEmail},getUserID(){return this.userID},getUserHasLogIn(){return this.userHasLogIn},getAdminToken(){return this.AdminToken}},actions:{setUserName(e){this.userName=e},setUserEmail(e){this.userEmail=e},setUserID(e){this.userID=e},setUserHasLogIn(e){this.userHasLogIn=e},async setAdminToken(){let e=this.getCookie("AdminToken");if(e)return e;const a={username:g,password:m},t=`${l}/admin/signin`,s=await u.post(t,a),{expired:r}=s.data;return e=s.data.token,document.cookie=`AdminToken=${e};expires=${new Date(r)}; path=/`,this.AdminToken=e,e},async AdminTokenCheck(e=!1){const a=await this.setAdminToken();if(this.AdminToken=this.getCookie("AdminToken"),this.userID=this.getCookie("UserID"),e&&this.userID&&this.AdminToken){this.userHasLogIn=!0;const t=`${l}/api/${c}/admin/products?category=使用者`;u.get(t,{headers:{Authorization:`${a}`}}).then(s=>{let r=Object.values(s.data.products).filter(n=>n.id===this.userID);r=r[0];const{username:o,email:h}=r;this.userName=o,this.userEmail=h||o,i.success("已登入 跳轉至首頁"),this.$router.push("/")}).catch(()=>{i.error("系統錯誤 請重新登入")})}},async Userlogin(e,a){if(!e||!a){i.error("請輸入帳號密碼");return}await this.getAlldata();try{const t=Object.values(this.Alldata).find(s=>{if(s.category==="使用者"&&s.email===e){if(s.password===a)return s;throw new Error("密碼錯誤")}return null});if(!t){i.error("帳號未註冊");return}if(Object.keys(t).length){const s=t.id;i.success("登入成功");const r=new Date(new Date().getTime()+1e3*60*60*24*7);document.cookie=`UserID=${s};expires=${r}; path=/`,this.userID=s,this.userName=t.username,this.userEmail=t.email,this.userHasLogIn=!0,this.$router.push("/")}else i.error("登入失敗")}catch(t){t.response.status===401&&this.UserLogout(),i.error("登入失敗 請稍後再試")}},async checkUserLogin(e=!0){this.userID=this.getCookie("UserID"),this.userID?(this.userHasLogIn=!0,this.Alldata?this.userData=this.Alldata[this.userID]:(await this.getAlldata(),this.userData=this.Alldata[this.userID])):(this.userHasLogIn=!1,e&&(this.$router.push("/login"),i.warning("請先登入")))},UserLogout(){document.cookie="UserID=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="AdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="RegToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",this.resetUserState(),i.success("已登出"),this.$router.push("/")},DashbordLogout(){document.cookie="DashbordAdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},PushUrl(e){this.$router.push(e)},resetUserState(){this.userName=null,this.userEmail=null,this.userID=null,this.userHasLogIn=!1},async getAlldata(e=!1){if(this.Alldata&&new Date-this.lastGetAllDataTime<2e3)return this.lastGetAllDataTime=new Date,this.Alldata;this.lastGetAllDataTime=new Date;let a=null;e?a=await this.getCookie("DashbordAdminToken"):a=await this.setAdminToken();const t=`${l}/api/${c}/admin/products/all`;return await u.get(t,{headers:{Authorization:`${a}`}}).then(r=>{this.Alldata=r.data.products}).finally(()=>this.Alldata)},async updateUserArtQuantity(e,a=!1){a&&await this.getAlldata();const t=Object.values(this.Alldata).filter(n=>n.category==="作品"&&n.author===e?n:null),s={...this.Alldata[e]};if(t.length===s.ArtQuantity)return;s.ArtQuantity=Object.values(t).length;const r=`${l}/api/${c}/admin/product/${e}`,o=await this.getCookie("AdminToken"),h={data:s};u.put(r,h,{headers:{Authorization:`${o}`}})},async checkUserhasArt(){await this.getAlldata();const e=new Set;Object.values(this.Alldata).forEach(a=>{a.category==="使用者"&&e.add(a.id)}),e.forEach(a=>{this.updateUserArtQuantity(a)})},getCookie(e){var t;return(t=document.cookie.split("; ").find(s=>s.startsWith(`${e}=`)))==null?void 0:t.split("=")[1]}}});export{D as U};
