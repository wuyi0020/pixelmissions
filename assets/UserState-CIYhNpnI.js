import{U as d,t as r}from"./index-C-_izT2N.js";import{a as u}from"./axios-Bo0ATomq.js";var A={VITE_URL:"https://vue3-course-api.hexschool.io/v2",VITE_API_PATH:"wuyi0020",VITE_ADMIN_USERNAME:"wuyi0020@gmail.com",VITE_ADMIN_PASSWORD:"wuyi0020",BASE_URL:"/pixelmissions/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const{VITE_URL:l,VITE_API_PATH:c,VITE_ADMIN_PASSWORD:m,VITE_ADMIN_USERNAME:g}=A,D=d("UserState",{state:()=>({userName:null,userEmail:null,userID:null,userHasLogIn:!1,AdminToken:null,Alldata:null,userData:null,lastGetAllDataTime:0}),getters:{getUserName(){return this.userName},getUserEmail(){return this.userEmail},getUserID(){return this.userID},getUserHasLogIn(){return this.userHasLogIn},getAdminToken(){return this.AdminToken}},actions:{setUserName(e){this.userName=e},setUserEmail(e){this.userEmail=e},setUserID(e){this.userID=e},setUserHasLogIn(e){this.userHasLogIn=e},async setAdminToken(){let e=this.getCookie("AdminToken");const a={username:g,password:m},s=`${l}/admin/signin`;return u.post(s,a).then(t=>{const{expired:i}=t.data;return e=t.data.token,document.cookie=`AdminToken=${e};expires=${new Date(i)}; path=/`,this.AdminToken=e,e}),e},async AdminTokenCheck(e=!1){const a=await this.setAdminToken();if(this.AdminToken=this.getCookie("AdminToken"),this.userID=this.getCookie("UserID"),e&&this.userID&&this.AdminToken){this.userHasLogIn=!0;const s=`${l}/api/${c}/admin/products?category=使用者`;u.get(s,{headers:{Authorization:`${a}`}}).then(t=>{let i=Object.values(t.data.products).filter(n=>n.id===this.userID);i=i[0];const{username:o,email:h}=i;this.userName=o,this.userEmail=h||o,r.success("已登入 跳轉至首頁"),this.$router.push("/")}).catch(()=>{r.error("系統錯誤 請重新登入")})}},async Userlogin(e,a){if(!e||!a){r.error("請輸入帳號密碼");return}await this.getAlldata();try{const s=Object.values(this.Alldata).find(t=>{if(t.category==="使用者"&&t.email===e){if(t.password===a)return t;throw new Error("密碼錯誤")}return null});if(!s){r.error("帳號未註冊");return}if(Object.keys(s).length){const t=s.id;r.success("登入成功");const i=new Date(new Date().getTime()+1e3*60*60*24*7);document.cookie=`UserID=${t};expires=${i}; path=/`,this.userID=t,this.userName=s.username,this.userEmail=s.email,this.userHasLogIn=!0,this.$router.push("/")}else r.error("登入失敗")}catch(s){s.response.status===401&&this.UserLogout(),r.error("登入失敗 請稍後再試")}},async checkUserLogin(e=!0){this.userID=this.getCookie("UserID"),this.userID?(this.userHasLogIn=!0,this.Alldata?this.userData=this.Alldata[this.userID]:(await this.getAlldata(),this.userData=this.Alldata[this.userID])):(this.userHasLogIn=!1,e&&(this.$router.push("/login"),r.warning("請先登入")))},UserLogout(){document.cookie="UserID=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="AdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="RegToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",this.resetUserState(),r.success("已登出"),this.$router.push("/")},DashbordLogout(){document.cookie="DashbordAdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},PushUrl(e){this.$router.push(e)},resetUserState(){this.userName=null,this.userEmail=null,this.userID=null,this.userHasLogIn=!1},async getAlldata(e=!1){if(this.Alldata&&new Date-this.lastGetAllDataTime<2e3)return this.lastGetAllDataTime=new Date,this.Alldata;this.lastGetAllDataTime=new Date;let a=null;e?a=await this.getCookie("DashbordAdminToken"):a=await this.setAdminToken();const s=`${l}/api/${c}/admin/products/all`;return await u.get(s,{headers:{Authorization:`${a}`}}).then(t=>{this.Alldata=t.data.products}),this.Alldata},async updateUserArtQuantity(e,a=!1){a&&await this.getAlldata();const s=Object.values(this.Alldata).filter(n=>n.category==="作品"&&n.author===e?n:null),t={...this.Alldata[e]};if(s.length===t.ArtQuantity)return;t.ArtQuantity=Object.values(s).length;const i=`${l}/api/${c}/admin/product/${e}`,o=await this.getCookie("AdminToken"),h={data:t};u.put(i,h,{headers:{Authorization:`${o}`}})},async checkUserhasArt(){await this.getAlldata();const e=new Set;Object.values(this.Alldata).forEach(a=>{a.category==="使用者"&&e.add(a.id)}),e.forEach(a=>{this.updateUserArtQuantity(a)})},getCookie(e){var s;return(s=document.cookie.split("; ").find(t=>t.startsWith(`${e}=`)))==null?void 0:s.split("=")[1]}}});export{D as U};
