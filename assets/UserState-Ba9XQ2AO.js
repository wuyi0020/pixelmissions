import{R as d,j as i}from"./index-Dp3lQOpW.js";import{a as l}from"./axios-Bo0ATomq.js";var g={VITE_URL:"https://vue3-course-api.hexschool.io/v2",VITE_API_PATH:"wuyi0020",VITE_ADMIN_USERNAME:"wuyi0020@gmail.com",VITE_ADMIN_PASSWORD:"wuyi0020",BASE_URL:"/pixelmissions/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const{VITE_URL:u,VITE_API_PATH:c,VITE_ADMIN_PASSWORD:A,VITE_ADMIN_USERNAME:m}=g,T=d("UserState",{state:()=>({userName:null,userEmail:null,userID:null,userHasLogIn:!1,AdminToken:null,Alldata:null,lastGetAllDataTime:0}),getters:{getUserName(){return this.userName},getUserEmail(){return this.userEmail},getUserID(){return this.userID},getUserHasLogIn(){return this.userHasLogIn},getAdminToken(){return this.AdminToken}},actions:{setUserName(e){this.userName=e},setUserEmail(e){this.userEmail=e},setUserID(e){this.userID=e},setUserHasLogIn(e){this.userHasLogIn=e},async setAdminToken(){let e=this.getCookie("AdminToken");const s={username:m,password:A},o=`${u}/admin/signin`;return l.post(o,s).then(t=>{const{expired:a}=t.data;return e=t.data.token,document.cookie=`AdminToken=${e};expires=${new Date(a)}; path=/`,this.AdminToken=e,e}),e},async AdminTokenCheck(e=!1){const s=await this.setAdminToken();if(this.AdminToken=this.getCookie("AdminToken"),this.userID=this.getCookie("UserID"),e&&this.userID&&this.AdminToken){this.userHasLogIn=!0;const o=`${u}/api/${c}/admin/products?category=使用者`;l.get(o,{headers:{Authorization:`${s}`}}).then(t=>{let a=Object.values(t.data.products).filter(r=>r.id===this.userID);a=a[0];const{username:n,email:h}=a;this.userName=n,this.userEmail=h||n,i.success("已登入 跳轉至首頁"),this.$router.push("/")}).catch(()=>{i.error("系統錯誤 請重新登入")})}},async Userlogin(e,s){if(!e||!s){i.error("請輸入帳號密碼");return}const o=await this.setAdminToken();console.log(o),await this.getAlldata(),console.log(this.Alldata);try{const t=Object.values(this.Alldata).find(a=>{if(a.category==="使用者"&&a.email===e){if(a.password===s)return a;throw new Error("密碼錯誤")}return null});if(console.log(t),!t){i.error("帳號未註冊");return}if(console.log(t),Object.keys(t).length){const a=t.id;i.success("登入成功");const n=new Date(new Date().getTime()+1e3*60*60*24*7);document.cookie=`UserID=${a};expires=${n}; path=/`,this.userID=a,this.userName=t.username,this.userEmail=t.email,this.userHasLogIn=!0,this.$router.push("/")}else i.error("登入失敗")}catch(t){console.log(t),t.response.status===401&&this.UserLogout(),i.error("登入失敗 請稍後再試")}},checkUserLogin(e=!0){this.userID=this.getCookie("UserID"),this.userID?this.userHasLogIn=!0:(this.userHasLogIn=!1,e&&(this.$router.push("/login"),i.warning("請先登入")))},UserLogout(){document.cookie="UserID=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="AdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",document.cookie="RegToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",this.resetUserState(),i.success("已登出"),this.$router.push("/")},DashbordLogout(){document.cookie="DashbordAdminToken=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},PushUrl(e){console.log(e),this.$router.push(e)},resetUserState(){this.userName=null,this.userEmail=null,this.userID=null,this.userHasLogIn=!1},async getAlldata(e=!1){if(this.Alldata&&new Date-this.lastGetAllDataTime<2e3)return this.lastGetAllDataTime=new Date,this.Alldata;this.lastGetAllDataTime=new Date;let s=null;e?s=await this.getCookie("DashbordAdminToken"):s=await this.setAdminToken();const o=`${u}/api/${c}/admin/products/all`;return await l.get(o,{headers:{Authorization:`${s}`}}).then(t=>{this.Alldata=t.data.products,console.log(t)}).catch(t=>{console.log(t)}),this.Alldata},async updateUserArtQuantity(e,s=!1){s&&await this.getAlldata();const o=Object.values(this.Alldata).filter(r=>r.category==="作品"&&r.author===e?r:null),t={...this.Alldata[e]};if(o.length===t.ArtQuantity)return;t.ArtQuantity=Object.values(o).length;const a=`${u}/api/${c}/admin/product/${e}`,n=await this.getCookie("AdminToken"),h={data:t};l.put(a,h,{headers:{Authorization:`${n}`}}).then(r=>{console.log(r)}).catch(r=>{console.log(r)})},async checkUserhasArt(){await this.getAlldata();const e=new Set;Object.values(this.Alldata).forEach(s=>{s.category==="使用者"&&e.add(s.id)}),console.log(e),e.forEach(s=>{console.log(s),this.updateUserArtQuantity(s)})},getCookie(e){var o;const s=(o=document.cookie.split("; ").find(t=>t.startsWith(`${e}=`)))==null?void 0:o.split("=")[1];return console.log(s),s}}});export{T as U};
